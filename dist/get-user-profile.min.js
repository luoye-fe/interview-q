/*
 * UserProfile v1.0.0
 * (c) 2017 luoye <luoyefe@gmail.com>
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.UserProfile=n()}(this,function(){"use strict";function e(e){console.log("\u8d70\u63a5\u53e3\u5566",e.toString());var e=e||[],n={},t=[];return e.forEach(function(e){n[e]||(n[e]=1,t.push(e))}),n=null,e=null,Promise.resolve().then(function(){return new Promise(function(e,n){setTimeout(function(){e()},1e3)}).then(function(){var e=t.map(function(e){return e<0?null:{uid:e,nick:e+"Nick",age:18}});return e.filter(function(e){return null!==e})})})}var n=(function(){function e(e){this.value=e}function n(n){function t(e,n){return new Promise(function(t,o){var c={key:e,arg:n,resolve:t,reject:o,next:null};r?r=r.next=c:(u=r=c,i(e,n))})}function i(t,u){try{var r=n[t](u),c=r.value;c instanceof e?Promise.resolve(c.value).then(function(e){i("next",e)},function(e){i("throw",e)}):o(r.done?"return":"normal",r.value)}catch(e){o("throw",e)}}function o(e,n){switch(e){case"return":u.resolve({value:n,done:!0});break;case"throw":u.reject(n);break;default:u.resolve({value:n,done:!1})}u=u.next,u?i(u.key,u.arg):r=null}var u,r;this._invoke=t,"function"!=typeof n.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new n(e.apply(this,arguments))}},await:function(n){return new e(n)}}}(),function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}),t=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),i=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},o=function(){function e(){n(this,e),this.cache={}}return t(e,[{key:"on",value:function(e,n){(this.cache[e]||(this.cache[e]=[])).push(n)}},{key:"once",value:function(e,n){function t(){this.off(e,t),n.apply(this,arguments)}this.on(e,t)}},{key:"off",value:function(e){this.cache[e]=null}},{key:"emit",value:function(e){var n=this,t=[].concat(Array.prototype.slice.call(arguments));t.shift();var i=this.cache[e];i&&i.length>0&&i.forEach(function(e){e.apply(n,t)})}}]),e}(),u=function(){function e(t){n(this,e),this.options=t||{},this.cacheMs=this.options.cacheMs||6e4,this.cache={}}return t(e,[{key:"set",value:function(e,n,t){this.cache[e]={val:n,setTime:Date.now(),cacheTime:t||this.cacheMs}}},{key:"get",value:function(e){return this.check(e),this.cache[e]?this.cache[e].val:null}},{key:"delete",value:function(e){delete this.cache[e]}},{key:"deleteAll",value:function(){this.cache={}}},{key:"check",value:function(e){var n=this.cache[e];n&&Date.now()-n.setTime>n.cacheTime&&this.delete(e)}}]),e}(),r=new u,c=new o,a=function(){function o(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,o),this.options=Object.assign({preLoadList:[]},e),this.cacheKey="user-profiles",this.queue=[].concat(i(new Set(this.options.preLoadList))),this.debounceRun=this.debounce(this.request.bind(this),100),this.debounceRun(this.queue)}return t(o,[{key:"get",value:function(e,n){var t=this;return new Promise(function(n,i){var o=r.get(e);o?n(o):(t.queue.push(e),c.on("done"+e,function(e){n(e)}),c.on("error"+e,function(e){i(e)}),t.debounceRun(t.queue,function(e){if(e)return i(e)}))})}},{key:"clear",value:function(){r.deleteAll()}},{key:"request",value:function(){function n(){var i=t.splice(0,100);e(i).then(function(e){return e.forEach(function(e){a[e.uid]=e,i.splice(i.indexOf(e.uid),1),r.set(e.uid,e),c.emit("done"+e.uid,e)}),i.forEach(function(e){c.emit("error"+e,{uid:e,error:!0})}),t.length?n():void(u.queue=[])}).catch(function(e){u.queue=[],o(e,a)})}var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},u=this,a={};t=[].concat(i(new Set(t))),n()}},{key:"debounce",value:function(e,n,t){var i=void 0;return function(){function o(){i=null,t||e.apply(u,r)}var u=this,r=arguments,c=t&&!i;clearTimeout(i),i=setTimeout(o,n),c&&e.apply(u,r)}}}]),o}();return a});