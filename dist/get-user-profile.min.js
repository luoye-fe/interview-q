/*
 * getUserProfile v1.0.0
 * (c) 2017 luoye <luoyefe@gmail.com>
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.getUserProfile=n()}(this,function(){"use strict";function e(e,n,t){var u=void 0;return function(){var r=this,i=arguments;return new Promise(function(o,c){function a(){u=null,t||f().then(function(e){return o(e)}).catch(function(e){c(e)})}function f(){return e.apply(r,i)}var h=t&&!u;clearTimeout(u),u=setTimeout(a,n),h&&f().then(function(e){return o(e)}).catch(function(e){c(e)})})}}function n(e){return new Promise(function(n,t){h.add(e),f.on("done",function(t){for(var u in t)if(void 0!==t[u].uid&&t[u].uid===e)return n(t[u])}),f.on("error",function(e){t(e)})})}var t=(function(){function e(e){this.value=e}function n(n){function t(e,n){return new Promise(function(t,r){var c={key:e,arg:n,resolve:t,reject:r,next:null};o?o=o.next=c:(i=o=c,u(e,n))})}function u(t,i){try{var o=n[t](i),c=o.value;c instanceof e?Promise.resolve(c.value).then(function(e){u("next",e)},function(e){u("throw",e)}):r(o.done?"return":"normal",o.value)}catch(e){r("throw",e)}}function r(e,n){switch(e){case"return":i.resolve({value:n,done:!0});break;case"throw":i.reject(n);break;default:i.resolve({value:n,done:!1})}i=i.next,i?u(i.key,i.arg):o=null}var i,o;this._invoke=t,"function"!=typeof n.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new n(e.apply(this,arguments))}},await:function(n){return new e(n)}}}(),function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}),u=function(){function e(e,n){for(var t=0;t<n.length;t++){var u=n[t];u.enumerable=u.enumerable||!1,u.configurable=!0,"value"in u&&(u.writable=!0),Object.defineProperty(e,u.key,u)}}return function(n,t,u){return t&&e(n.prototype,t),u&&e(n,u),n}}(),r=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},i=function(){function e(n){t(this,e),this.options=n||{},this.cacheMs=this.options.cacheMs||6e4,this.cache={}}return u(e,[{key:"set",value:function(e,n,t){this.cache[e]={val:n,setTime:Date.now(),cacheTime:t||this.cacheMs}}},{key:"get",value:function(e){return this.check(e),this.cache[e]?this.cache[e].val:null}},{key:"delete",value:function(e){delete this.cache[e]}},{key:"check",value:function(e){var n=this.cache[e];n&&Date.now()-n.setTime>n.cacheTime&&this.delete(e)}}]),e}(),o=function(){function e(){t(this,e),this.cache={}}return u(e,[{key:"on",value:function(e,n){(this.cache[e]||(this.cache[e]=[])).push(n)}},{key:"once",value:function(e,n){function t(){this.off(e,t),n.apply(this,arguments)}this.on(e,t)}},{key:"off",value:function(e){this.cache[e]=null}},{key:"emit",value:function(e){var n=this,t=[].concat(Array.prototype.slice.call(arguments));t.shift();var u=this.cache[e];u&&u.length>0&&u.forEach(function(e){e.apply(n,t)})}}]),e}(),c=function(e){console.log("\u8d70\u63a5\u53e3\u5566",e.toString());var e=e||[],n={},t=[];return e.forEach(function(e){n[e]||(n[e]=1,t.push(e))}),n=null,e=null,Promise.resolve().then(function(){return new Promise(function(e,n){setTimeout(function(){e()},1e3)}).then(function(){var e=t.map(function(e){return e<0?{uid:e,error:!0,e:"\u51fa\u9519\u5566"}:{uid:e,nick:e+"Nick",age:18}});return e.filter(function(e){return null!==e})})})},a=function(){function n(){t(this,n),this.queue=[],this.debounceRun=e(this.runRealReQuest,100),this.extraQueue=[]}return u(n,[{key:"add",value:function(e){this.queue.indexOf(e)===-1&&(this.queue.length>=100?this.extraQueue.push(e):this.queue.push(e)),this.run()}},{key:"run",value:function(){var e=this;this.debounceRun().then(function(n){e.loop(n)}).catch(function(n){e.loop(null,n)})}},{key:"loop",value:function(e,n){return n?f.emit("error",n):(f.emit("done",e),this.queue=[],void(this.extraQueue.length&&(this.queue=this.extraQueue.splice(0,100),this.run())))}},{key:"runRealReQuest",value:function(){var e=this;return new Promise(function(n,t){var u=[],i=[].concat(r(e.queue));for(var o in e.queue){var a=s.get(e.queue[o]);a&&(u.push(a),i.shift())}e.queue=i,e.queue.length?c(e.queue).then(function(e){for(var t in e)e[t].error||s.set(e[t].uid,e[t]);n(u.concat(e))}).catch(function(e){t(e)}):n(u)})}}]),n}(),f=new o,h=new a,s=new i;return n});