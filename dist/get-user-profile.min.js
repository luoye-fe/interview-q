/*
 * GetUserProfile v1.0.0
 * (c) 2017 luoye <luoyefe@gmail.com>
 */
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):e.GetUserProfile=n()}(this,function(){"use strict";function e(e){console.log("\u8d70\u63a5\u53e3\u5566",e.toString());var e=e||[],n={},t=[];return e.forEach(function(e){n[e]||(n[e]=1,t.push(e))}),n=null,e=null,Promise.resolve().then(function(){return new Promise(function(e,n){setTimeout(function(){e()},1e3)}).then(function(){var e=t.map(function(e){return e<0?null:{uid:e,nick:e+"Nick",age:18}});return e.filter(function(e){return null!==e})})})}var n=(function(){function e(e){this.value=e}function n(n){function t(e,n){return new Promise(function(t,i){var c={key:e,arg:n,resolve:t,reject:i,next:null};r?r=r.next=c:(u=r=c,o(e,n))})}function o(t,u){try{var r=n[t](u),c=r.value;c instanceof e?Promise.resolve(c.value).then(function(e){o("next",e)},function(e){o("throw",e)}):i(r.done?"return":"normal",r.value)}catch(e){i("throw",e)}}function i(e,n){switch(e){case"return":u.resolve({value:n,done:!0});break;case"throw":u.reject(n);break;default:u.resolve({value:n,done:!1})}u=u.next,u?o(u.key,u.arg):r=null}var u,r;this._invoke=t,"function"!=typeof n.return&&(this.return=void 0)}return"function"==typeof Symbol&&Symbol.asyncIterator&&(n.prototype[Symbol.asyncIterator]=function(){return this}),n.prototype.next=function(e){return this._invoke("next",e)},n.prototype.throw=function(e){return this._invoke("throw",e)},n.prototype.return=function(e){return this._invoke("return",e)},{wrap:function(e){return function(){return new n(e.apply(this,arguments))}},await:function(n){return new e(n)}}}(),function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}),t=function(){function e(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(n,t,o){return t&&e(n.prototype,t),o&&e(n,o),n}}(),o=function(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)},i=function(){function e(){n(this,e),this.cache={}}return t(e,[{key:"on",value:function(e,n){(this.cache[e]||(this.cache[e]=[])).push(n)}},{key:"once",value:function(e,n){function t(){this.off(e,t),n.apply(this,arguments)}this.on(e,t)}},{key:"off",value:function(e){this.cache[e]=null}},{key:"emit",value:function(e){var n=this,t=[].concat(Array.prototype.slice.call(arguments));t.shift();var o=this.cache[e];o&&o.length>0&&o.forEach(function(e){e.apply(n,t)})}}]),e}(),u=function(){function e(t){n(this,e),this.options=t||{},this.cacheMs=this.options.cacheMs||6e4,this.cache={}}return t(e,[{key:"set",value:function(e,n,t){this.cache[e]={val:n,setTime:Date.now(),cacheTime:t||this.cacheMs}}},{key:"get",value:function(e){return this.check(e),this.cache[e]?this.cache[e].val:null}},{key:"delete",value:function(e){delete this.cache[e]}},{key:"deleteAll",value:function(){this.cache={}}},{key:"check",value:function(e){var n=this.cache[e];n&&Date.now()-n.setTime>n.cacheTime&&this.delete(e)}}]),e}(),r=new u,c=new i,a=function(){function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,i),this.options=Object.assign({preLoadList:[]},e),this.queue=[].concat(o(new Set(this.options.preLoadList))),this.debounceCollect=this.debounce(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){};return e()},100),this.queue.length&&this.debounceCollect(this.request.bind(this,this.queue))}return t(i,[{key:"get",value:function(e){var n=this;return new Promise(function(t,i){var u=r.get(e);return u?t(u):(n.queue.indexOf(e)===-1&&n.queue.push(e),c.on("done"+e,function(e){t(e)}),c.on("error"+e,function(e){i(e)}),void n.debounceCollect(function(){var e=[].concat(o(n.queue));n.queue=[],n.request(e,function(e){if(e)return i(e)})}))})}},{key:"clear",value:function(){r.deleteAll()}},{key:"request",value:function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){},o={};e(n).then(function(e){e.forEach(function(e){o[e.uid]=e,n.splice(n.indexOf(e.uid),1),r.set(e.uid,e),c.emit("done"+e.uid,e)}),n.forEach(function(e){c.emit("error"+e,{uid:e,error:!0})})}).catch(function(e){t(e,o)})}},{key:"debounce",value:function(e,n){var t=void 0,o=void 0,i=Date.now();return function(){function u(){i=Date.now(),t=null,e.apply(r,c)}var r=this,c=arguments;clearTimeout(t),o=Date.now()-i,o>n?u():t=setTimeout(u,n-o)}}}]),i}();return a});